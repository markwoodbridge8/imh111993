define(["require","exports","@walletconnect/client","algosdk","bowser"],(function(e,t,n,o,i){"use strict";function r(e,t,n,o){return new(n||(n=Promise))((function(i,r){function l(e){try{c(o.next(e))}catch(e){r(e)}}function s(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,s)}c((o=o.apply(e,t||[])).next())}))}class l extends Error{constructor(e,t,...n){super(...n),Error.captureStackTrace&&Error.captureStackTrace(this,l),this.name="DeflyWalletConnectError",this.data=e,this.message=t}}const s="defly-wallet-connect-modal-wrapper",c="defly-wallet-redirect-modal-wrapper",d="defly-wallet-sign-txn-toast-wrapper",a="defly-wallet-modal";function u(e){const t=document.createElement("div");return t.setAttribute("id",e),document.body.appendChild(t),t}function h(e){const t=document.getElementById(e);t&&t.remove()}const f={WALLET:"DeflyWallet.Wallet",WALLETCONNECT:"walletconnect"};function g(){return"undefined"==typeof localStorage?void 0:localStorage}function v(){var e;const t=null===(e=g())||void 0===e?void 0:e.getItem(f.WALLET);return t?JSON.parse(t):null}function m(e){const t=e.slice();for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}const w="https://static.defly.app/wc-bridge-servers.json";function y(){return function(e,t={}){return fetch(e,t).then((e=>e.json())).then((e=>e))}(w,{cache:"no-store"})}function p(){return r(this,void 0,void 0,(function*(){let e={bridgeURL:"",shouldUseSound:!0,silent:!1};try{const t=yield y();void 0!==t.use_sound&&(e.shouldUseSound=t.use_sound),void 0!==t.silent&&(e.silent=t.silent),e=Object.assign(Object.assign({},e),{bridgeURL:m(t.servers||[])[0]||""})}catch(e){console.log(e)}return e}))}function T(e){return Uint8Array.from(window.atob(e),(e=>e.charCodeAt(0)))}function S(){return"undefined"!=typeof navigator}function L(){return S()&&/iPhone|iPod|iPad|Android/i.test(navigator.userAgent)}function E({shouldUseSound:e,bridge:t}){return{open:(n={shouldUseSound:e,bridge:t},e=>{if(!document.getElementById(s)){const t=u(s),o=`${e.replace(/bridge=[^&]+/,`bridge=${encodeURIComponent(n.bridge)}`)}&algorand=true`,{shouldUseSound:i}=n;t.innerHTML=`<defly-wallet-connect-modal uri="${o}" should-use-sound="${i}"></defly-wallet-connect-modal>`}}),close:()=>h(s)};var n}"undefined"!=typeof window&&(window.global=window,window.Buffer=window.Buffer||e("buffer").Buffer,new Promise((function(t,n){e(["./App-cf93125f"],t,n)}))),t.DEFLY_WALLET_CONNECT_MODAL_ID=s,t.DEFLY_WALLET_MODAL_CLASSNAME=a,t.DEFLY_WALLET_REDIRECT_MODAL_ID=c,t.DEFLY_WALLET_SIGN_TXN_MODAL_ID="defly-wallet-sign-txn-modal-wrapper",t.DEFLY_WALLET_SIGN_TXN_TOAST_ID=d,t.DeflyWalletConnect=class{constructor(e){this.bridge=(null==e?void 0:e.bridge)||"",this.connector=null,this.shouldShowSignTxnToast=void 0===(null==e?void 0:e.shouldShowSignTxnToast)||e.shouldShowSignTxnToast,this.chainId=null==e?void 0:e.chainId}get platform(){return function(){const e=v();let t=null;return"defly-wallet"===(null==e?void 0:e.type)&&(t="mobile"),t}()}get isConnected(){return"mobile"===this.platform&&!!this.connector}connect(){return new Promise(((e,t)=>r(this,void 0,void 0,(function*(){var o;try{if(null===(o=this.connector)||void 0===o?void 0:o.connected)try{yield this.connector.killSession()}catch(e){}const{bridgeURL:i,shouldUseSound:r}=yield p();this.connector=new n({bridge:this.bridge||i||"https://bridge.walletconnect.org",qrcodeModal:E({shouldUseSound:r,bridge:this.bridge||i||"https://bridge.walletconnect.org"})}),yield this.connector.createSession({chainId:this.chainId||4160}),function(e){var t,n,o,i;const r=document.getElementById(s),l=null===(n=null===(t=null==r?void 0:r.querySelector("defly-wallet-connect-modal"))||void 0===t?void 0:t.shadowRoot)||void 0===n?void 0:n.querySelector(`.${a}`),c=null===(i=null===(o=null==l?void 0:l.querySelector("defly-wallet-modal-header"))||void 0===o?void 0:o.shadowRoot)||void 0===i?void 0:i.getElementById("defly-wallet-modal-header-close-button");null==c||c.addEventListener("click",(()=>{e(),h(s)}))}((()=>t(new l({type:"CONNECT_MODAL_CLOSED"},"Connect modal is closed by user")))),this.connector.on("connect",((n,o)=>{var i,r;n&&t(n),e((null===(i=this.connector)||void 0===i?void 0:i.accounts)||[]),function(e,t){var n;null===(n=g())||void 0===n||n.setItem(f.WALLET,JSON.stringify({type:t||"defly-wallet",accounts:e,selectedAccount:e[0]}))}((null===(r=this.connector)||void 0===r?void 0:r.accounts)||[])}))}catch(e){t(new l({type:"SESSION_CONNECT",detail:e},e.message||"There was an error while connecting to Defly Wallet"))}}))))}reconnectSession(){return new Promise(((e,t)=>r(this,void 0,void 0,(function*(){var o,i;try{if(!v())return void e([]);this.connector&&e(this.connector.accounts||[]),this.bridge=(null===(o=function(){var e;const t=null===(e=g())||void 0===e?void 0:e.getItem(f.WALLETCONNECT);return t?JSON.parse(t):null}())||void 0===o?void 0:o.bridge)||"",this.bridge&&(this.connector=new n({bridge:this.bridge}),e((null===(i=this.connector)||void 0===i?void 0:i.accounts)||[])),this.isConnected||e([])}catch(e){yield this.disconnect(),t(new l({type:"SESSION_RECONNECT",detail:e},e.message||"There was an error while reconnecting to Defly Wallet"))}}))))}disconnect(){var e;return r(this,void 0,void 0,(function*(){let t;this.isConnected&&"mobile"===this.platform&&(t=null===(e=this.connector)||void 0===e?void 0:e.killSession(),null==t||t.then((()=>{this.connector=null}))),yield new Promise(((e,t)=>{var n,o;try{null===(n=g())||void 0===n||n.removeItem(f.WALLETCONNECT),null===(o=g())||void 0===o||o.removeItem(f.WALLET),e(void 0)}catch(e){t(e)}}))}))}signTransactionWithMobile(e){return r(this,void 0,void 0,(function*(){const t=(n="algo_signTxn",o=[e],{id:Date.now()*Math.pow(10,3)+Math.floor(Math.random()*Math.pow(10,3)),jsonrpc:"2.0",method:n,params:o});var n,o;try{try{const{silent:e}=yield p(),n=(yield this.connector.sendCustomRequest(t,{forcePushNotification:!e})).filter(Boolean);return"string"==typeof n[0]?n.map(T):n.map((e=>Uint8Array.from(e)))}catch(e){return yield Promise.reject(new l({type:"SIGN_TRANSACTIONS",detail:e},e.message||"Failed to sign transaction"))}}finally{h(c),h(d)}}))}signTransaction(e,t){return r(this,void 0,void 0,(function*(){if("mobile"===this.platform&&(L()?u(c).innerHTML="<defly-wallet-redirect-modal></defly-wallet-redirect-modal>":!L()&&this.shouldShowSignTxnToast&&(u(d).innerHTML="<defly-wallet-sign-txn-toast></defly-wallet-sign-txn-toast>"),!this.connector))throw new Error("DeflyWalletConnect was not initialized correctly.");const n=e.flatMap((e=>e.map((e=>function(e,t){let n;t&&!(e.signers||[]).includes(t)&&(n=[]);const i={txn:(r=e.txn,Buffer.from(o.encodeUnsignedTransaction(r)).toString("base64"))};var r;return Array.isArray(n)&&(i.signers=n),e.authAddr&&(i.authAddr=e.authAddr),e.message&&(i.message=e.message),e.msig&&(i.msig=e.msig),i}(e,t)))));return this.signTransactionWithMobile(n)}))}},t.closeDeflyWalletSignTxnToast=function(){h(d)},t.detectBrowser=function(){if(!S())return null;const{userAgent:e}=navigator;let t;return t=e.match(/DuckDuckGo/i)?"DuckDuckGo":e.match(/OPX/i)?"Opera GX":navigator.brave?"Brave":i.getParser(navigator.userAgent).getBrowserName(),t},t.isAndroid=function(){return S()&&/Android/i.test(navigator.userAgent)},t.isIOS=function(){return S()&&/iPhone|iPad|iPod/i.test(navigator.userAgent)},t.isMobile=L,t.removeModalWrapperFromDOM=h}));
